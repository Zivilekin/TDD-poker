"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const replacers = require("./replacers");
const postcss = require("postcss");
function isCssVar(key) {
    return key.indexOf('--') === 0;
}
const customSyntaxRegex = /"\w+\([^"]*\)"/g;
function collectCustomSyntaxFrom(value, customSyntaxStrs) {
    let match;
    if ((match = value.match(customSyntaxRegex))) {
        customSyntaxStrs.push(...match);
    }
}
exports.extractTPACustomSyntax = postcss.plugin('postcss-wix-tpa-style', (opts = {}) => {
    const cssVars = {};
    const customSyntaxStrs = [];
    return (css) => {
        css.walkDecls((decl) => {
            Object.keys(replacers).forEach(replacerName => (decl = replacers[replacerName](decl)));
            if (isCssVar(decl.prop)) {
                cssVars[decl.prop] = decl.value;
            }
            collectCustomSyntaxFrom(decl.prop, customSyntaxStrs);
            collectCustomSyntaxFrom(decl.value, customSyntaxStrs);
        });
        if (typeof opts.onFinish === 'function') {
            const uniqueCustomSyntaxStrs = customSyntaxStrs.filter((value, index, self) => self.indexOf(value) === index);
            opts.onFinish({ cssVars, customSyntaxStrs: uniqueCustomSyntaxStrs, css: css.toString() });
        }
    };
});
